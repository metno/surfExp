
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>This repository is a setup to create and run offline SURFEX experiments. &#8212; Pysurfex-experiment  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Pysurfex-experiment  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">This repository is a setup to create and run offline SURFEX experiments.</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <img alt="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" id="readme" src="https://coveralls.io/repos/github/metno/pysurfex-experiment/badge.svg?branch=master" />
<p><a class="reference external" href="https://coveralls.io/github/metno/pysurfex-experiment">https://coveralls.io/github/metno/pysurfex-experiment</a></p>
<section id="this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments">
<h1>This repository is a setup to create and run offline SURFEX experiments.<a class="headerlink" href="#this-repository-is-a-setup-to-create-and-run-offline-surfex-experiments" title="Permalink to this headline">¶</a></h1>
<p>See online documentation in <a class="reference external" href="https://metno.github.io/pysurfex-experiment/">https://metno.github.io/pysurfex-experiment/</a>
The setup is dependent of pysurfex (<a class="reference external" href="https://metno.github.io/pysurfex">https://metno.github.io/pysurfex</a>) and pysurfex-scheduler (<a class="reference external" href="https://metno.github.io/pysurfex">https://metno.github.io/pysurfex</a>)</p>
<p>You need a python3 parser and the following dependencies are needed. Install the non-standard ones e.g. with pip or your system installation system. Requirements can be found in <a class="reference external" href="https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt">https://github.com/metno/pysurfex-experiment/blob/master/requirements.txt</a></p>
<section id="general-dependencies-from-pypi">
<h2>General dependencies (from pypi)<a class="headerlink" href="#general-dependencies-from-pypi" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pysurfex
pysurfex-scheduler
</pre></div>
</div>
<p>pysurfex and pysurfex-scheduler bring extra dependencies like gridpp, titanlib and ecflow. If you install from pypi with pip these should be handled automatically.</p>
</section>
<section id="code-unit-testing-and-coverage">
<h2>Code unit testing and coverage<a class="headerlink" href="#code-unit-testing-and-coverage" title="Permalink to this headline">¶</a></h2>
<p>Extra dependencies for testing</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>unittest
nose
</pre></div>
</div>
<p>Create coverage/test by executing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./create_coverage.sh
</pre></div>
</div>
<p>Create documentation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
<span class="c1"># Create html documentation</span>
make html
<span class="c1"># Create latex documentation</span>
make latex
<span class="c1"># Create a pdf documentation</span>
make latexpdf
</pre></div>
</div>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Assume you have cloned experiment in pysurfex-experiment-clone-dir. Let us set some variables we can use in the examples in addition to some system settings. Adjust it to your clone, host-tag and system</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="o">=</span><span class="s2">&quot;pysurfex-experiment-clone-dir&quot;</span>
<span class="nb">export</span> <span class="nv">HOST_TAG</span><span class="o">=</span><span class="s2">&quot;my-host-tag&quot;</span>
<span class="nb">export</span> <span class="nv">PYSURFEX</span><span class="o">=</span><span class="s2">&quot;path-to-your-pysurfex-installation&quot;</span>
<span class="nb">export</span> <span class="nv">OFFLINE_SOURCE_CODE</span><span class="o">=</span><span class="s2">&quot;path-to-your-offline-source-code&quot;</span>
<span class="nb">export</span> <span class="nv">SCHEDULER_PYTHONPATH</span> <span class="o">=</span> <span class="s2">&quot;path-to-pysurfex-scheduler:path-to-ecflow-python-module&quot;</span>
<span class="nb">export</span> <span class="nv">SCHEDULER_PATH</span><span class="o">=</span><span class="s2">&quot;path-to-ecflow-bin-dir&quot;</span>

<span class="c1"># Set PYTHONPATH</span>
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>:<span class="si">${</span><span class="nv">SCHEDULER_PYTHONPATH</span><span class="si">}</span>:<span class="nv">$PYTHONPATH</span>

<span class="c1"># Set PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">SCHEDULER_PATH</span><span class="si">}</span>:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>The reason you need to adjust the path is that the scheduler uses the ecflow start scripts to start the server.
If you have installed PYSURFEX and/or pysurfex-scheduler with pip you might try this to find the installation directories:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -c <span class="s2">&quot;import surfex; print(surfex.__path__[0] + &#39;/..&#39;)&quot;</span>
python -c <span class="s2">&quot;import scheduler; print(scheduler.__path__[0] + &#39;/..&#39;)&quot;</span>
</pre></div>
</div>
<p>Make sure you have the host you want to run on defined in pysurfex-experiment-clone-dir/config/<em>/host-name-tag</em>. There is a file for:</p>
<ul class="simple">
<li><dl class="simple">
<dt>system -&gt; sym-linked to Env_system in setup</dt><dd><ul>
<li><p>Definition of experiment structure and system commands. The pythonpath for the scheduler should be defined as SCHEDULER_PYTHONPATH for each host in this file</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>submit -&gt; sym-linked to Env_submit in setup</dt><dd><ul>
<li><p>Definition of submission of the job tasks, e.g to a batch system</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>server -&gt; sym-linked to  Env_server in setup</dt><dd><ul>
<li><p>Definition of the scheduler running, e.g an ecflow server</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>env -&gt; sym-linked to Env in setup</dt><dd><ul>
<li><p>Definition of a host specific environment used in the beginning og job files</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>input_paths -&gt; sym-linked to Env_input_paths in setup</dt><dd><ul>
<li><p>Definiton of paths and structure of the experiment and input data</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Now you can set up your experiment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span>
mkdir -p sfx_home
<span class="nb">cd</span> sfx_home
mkdir -p my_exp
<span class="nb">cd</span> my_exp
<span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span>/bin/PySurfexExpSetup <span class="se">\</span>
 -experiment <span class="si">${</span><span class="nv">PYSURFEX_EXPERIMENT_PATH</span><span class="si">}</span> <span class="se">\</span>
 -host <span class="si">${</span><span class="nv">HOST_TAG</span><span class="si">}</span> <span class="se">\</span>
 -surfex <span class="si">${</span><span class="nv">PYSURFEX</span><span class="si">}</span> <span class="se">\</span>
 -offline <span class="si">${</span><span class="nv">OFFLINE_SOURCE_CODE</span><span class="si">}</span>
</pre></div>
</div>
<p>You now a experiment which you can modify to your needs. You can choose to run with existing binaries without specifying -offline when setting up and add the proper bin_dir to our Env_input_files file. Instead of the -experiment argument you can also specify a full existing experiment by using the -rev argument.</p>
<p>If you run ecflow with SSL support, remember to add before starting:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">ECF_SSL</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>This must also be added to your job tasks for example in the Env file for communication with your server fom the batch job. Finally you can start your experiment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/PySurfexExp start -dtg <span class="m">2022020100</span> -dtgend <span class="m">2022020103</span>
</pre></div>
</div>
<p>All batch jobs start from local json files with configuration of server, system and you configuration found on the scratch directory on the whost you run on. It means if you do local configuration changes you will need to either start/continue the run with “PySurfexExp start/prod” or you can execute PySurfexExpConfig and then sync files from HOME on HOST0 to scratch on the used hosts by executing the InitRun task in the scheduler. InitRun alone will not update your configurations, only sync files.</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference external" href="https://metno.github.io/pysurfex-experiment/#examples">https://metno.github.io/pysurfex-experiment/#examples</a></p>
</section>
<section id="trainings">
<h2>Trainings<a class="headerlink" href="#trainings" title="Permalink to this headline">¶</a></h2>
<p><cite>Budapest May 2022 &lt;https://github.com/metno/pysurfex-experiment/blob/master/trainings/budapest_may_2022.rst/&gt;</cite></p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">This repository is a setup to create and run offline SURFEX experiments.</a><ul>
<li><a class="reference internal" href="#general-dependencies-from-pypi">General dependencies (from pypi)</a></li>
<li><a class="reference internal" href="#code-unit-testing-and-coverage">Code unit testing and coverage</a></li>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#examples">Examples</a></li>
<li><a class="reference internal" href="#trainings">Trainings</a></li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/README.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Pysurfex-experiment  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">This repository is a setup to create and run offline SURFEX experiments.</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Trygve Aspelien.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>